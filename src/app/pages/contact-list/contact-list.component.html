<div class="d-flex flex-column h-100 bg-light-app">
  <div
    class="d-flex align-items-center justify-content-between px-3 py-3 border-bottom sticky-top bg-white shadow-sm z-3"
  >
    <h5 class="mb-0 fw-bold text-dark">Cloud Contacts</h5>
    <button
      mat-icon-button
      color="primary"
      (click)="loadContacts()"
      [disabled]="isLoading"
    >
      <mat-icon>refresh</mat-icon>
    </button>
    <!-- <button mat-fab color="primary" class="fab-bottom-right">
      <mat-icon>add</mat-icon>
    </button> -->
    <button mat-icon-button color="primary" (click)="toggleAddForm()">
      <mat-icon>{{ isAddingContact ? "close" : "add" }}</mat-icon>
    </button>
  </div>

  <div class="container-fluid px-3 py-4 flex-grow-1 overflow-auto">
    <div
      *ngIf="isAddingContact"
      class="card border-0 shadow-sm mb-4 rounded-4 bg-white animate-slide-down"
    >
      <div class="card-body p-3">
        <h6 class="fw-bold text-primary mb-3">New Contact</h6>

        <div class="mb-3">
          <input
            type="text"
            class="form-control bg-light border-0 py-2"
            placeholder="Full Name"
            [(ngModel)]="newContact.fullName"
          />
        </div>

        <div class="mb-3">
          <input
            type="tel"
            class="form-control bg-light border-0 py-2"
            maxlength="10"
            placeholder="Mobile (10 digits)"
            [(ngModel)]="newContact.mobile"
          />
        </div>

        <button
          class="btn btn-primary w-100 rounded-3 py-2 fw-bold"
          (click)="saveContact()"
          [disabled]="!newContact.fullName || newContact.mobile.length < 10"
        >
          Save Contact
        </button>
      </div>
    </div>

    <div class="mb-4" *ngIf="!isAddingContact">
      <button
        (click)="pickAndUpload()"
        [disabled]="isUploading"
        class="btn btn-action w-100 py-3 d-flex align-items-center justify-content-center gap-2 shadow-sm text-primary bg-white border-0"
      >
        <mat-spinner *ngIf="isUploading" diameter="20"></mat-spinner>
        <i *ngIf="!isUploading" class="bi bi-cloud-arrow-up-fill fs-4"></i>

        <span class="fw-bold fs-6">
          {{ isUploading ? "Syncing..." : "Upload Device Contacts" }}
        </span>
      </button>
      <div class="text-center mt-2">
        <small class="text-muted" style="font-size: 0.75rem"
          >Exports phone contacts to Cloud API</small
        >
      </div>
    </div>
    <div class="mb-4 position-relative">
      <span
        class="position-absolute top-50 start-0 translate-middle-y ps-3 text-secondary"
      >
        <i class="bi bi-search"></i>
      </span>

      <input
        type="text"
        class="form-control search-input ps-5 pe-5"
        placeholder="Search name or mobile..."
        [formControl]="searchControl"
        (keydown.escape)="clearSearch()"
      />
      <button
        *ngIf="showClear$ | async"
        (click)="clearSearch()"
        class="btn btn-link position-absolute top-50 end-0 translate-middle-y text-secondary text-decoration-none pe-3"
      >
        <i class="bi bi-x-circle-fill"></i>
      </button>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3 px-1">
      <h6 class="text-secondary fw-bold small text-uppercase ls-1 mb-0">
        Saved Contacts ({{ contacts.length }})
      </h6>
    </div>

    <div *ngIf="isLoading" class="d-flex justify-content-center py-5">
      <mat-spinner diameter="40"></mat-spinner>
    </div>

    <!-- ðŸ“ƒ Contact List -->
    <ng-container *ngIf="filteredContacts$ | async as contacts">
      <div
        class="d-flex flex-column gap-3 pb-5"
        *ngIf="!isLoading && contacts.length"
      >
        <div *ngFor="let contact of contacts" class="contact-card p-3">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <h5 class="fw-bold mb-2 text-dark fs-4">
                {{ contact.fullName }}
              </h5>
              <span class="badge bg-light text-dark border fs-6 py-2 px-3">
                +91 {{ contact.mobile }}
              </span>
            </div>

            <div
              class="avatar rounded-circle d-flex align-items-center justify-content-center shadow-sm"
              style="
                width: 56px;
                height: 56px;
                font-size: 1.5rem;
                min-width: 56px;
              "
            >
              {{ contact.fullName.charAt(0) | uppercase }}
            </div>
          </div>

          <div class="d-flex gap-2">
            <button
              (click)="makeCall(contact.mobile)"
              class="btn btn-action flex-fill py-2"
            >
              <i class="bi bi-telephone-fill me-1"></i> Call
            </button>

            <button
              (click)="onPay(contact)"
              class="btn btn-action flex-fill py-2 text-primary"
            >
              <i class="bi bi-currency-rupee"></i> Pay
            </button>

            <button
              (click)="openWhatsApp(contact.mobile)"
              class="btn btn-action flex-fill py-2"
            >
              <i class="bi bi-whatsapp me-1"></i> Chat
            </button>

            <button (click)="shareContact(contact)" class="btn btn-action px-3">
              <i class="bi bi-share-fill"></i>
            </button>

            <button
              (click)="onDelete(contact)"
              class="btn btn-action px-3 text-danger"
            >
              <i class="bi bi-trash3-fill"></i>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="contacts.length === 0" class="text-center mt-5 text-muted">
        <p>No contacts found.</p>
      </div>
    </ng-container>

    <!-- <div class="d-flex flex-column gap-3 pb-5" *ngIf="!isLoading">
      <div *ngFor="let contact of filteredContacts" class="contact-card p-3">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div>
            <h5 class="fw-bold mb-2 text-dark fs-4">
              {{ contact.fullName }}
            </h5>
            <span class="badge bg-light text-dark border fs-6 py-2 px-3">
              +91 {{ contact.mobile }}
            </span>
          </div>

          <div
            class="avatar rounded-circle d-flex align-items-center justify-content-center shadow-sm"
            style="
              width: 56px;
              height: 56px;
              font-size: 1.5rem;
              min-width: 56px;
            "
          >
            {{ contact.fullName.charAt(0) | uppercase }}
          </div>
        </div>

        <div class="d-flex gap-2">
          <button
            (click)="makeCall(contact.mobile)"
            class="btn btn-action flex-fill py-2"
          >
            <i class="bi bi-telephone-fill me-1"></i> Call
          </button>

          <button
            (click)="onPay(contact)"
            class="btn btn-action flex-fill py-2 text-primary"
          >
            <i class="bi bi-currency-rupee"></i> Pay
          </button>

          <button
            (click)="openWhatsApp(contact.mobile)"
            class="btn btn-action flex-fill py-2"
          >
            <i class="bi bi-whatsapp me-1"></i> Chat
          </button>

          <button (click)="shareContact(contact)" class="btn btn-action px-3">
            <i class="bi bi-share-fill"></i>
          </button>

          <button
            (click)="onDelete(contact)"
            class="btn btn-action px-3 text-danger"
          >
            <i class="bi bi-trash3-fill"></i>
          </button>
        </div>
      </div>

      <div *ngIf="contacts.length === 0" class="text-center mt-5 text-muted">
        <p>No contacts found.</p>
      </div>
    </div> -->
  </div>
</div>
